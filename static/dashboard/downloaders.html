<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>BigSemantics Logs</title>

  <style type="text/css">
    .ui.menu .item img.logo {
      margin-right: 1.5em;
    }
    
    .main.container {
      margin-top: 2em;
    }
    
    .tasks {
      margin-top: 2em;
    }
    
    td > a {
      cursor: pointer;
      cursor: hand;
    }
  </style>

  <script src="dist/jquery.min.js"></script>
  <script src="dist/semantic.min.js"></script>
  <script src="dist/handlebars.js"></script>
  <script src="dist/time-elements.js"></script>

  <script id="downloaders-template" type="text/x-handlebars-template">
    <thead>
      <tr>
        <th>Host</th>
        <th>Local Port</th>
        <th>Avg. Download Rate</th>
        <th>State</th>
      </tr>
    </thead>
    <tbody>
      {{#each this}}
        <tr {{{showError this}}}>
          <td>{{id}}</td>
          <td>{{socksPort}}</td>
          <td>{{{formatSpeed stats.speed}}}</td>
          <td>{{state}}</td>
        </tr>
      {{/each}}
    </tbody>
  </script>

  <script type="text/javascript">
    var downloadersTemplate = Handlebars.compile($("#downloaders-template").html());

    $(document).ready(function() {
      Handlebars.registerHelper("showError", function(worker) {
        if(worker.state != 'ready' && worker.state != 'busy') {
          return "class = \"error\"";
        } else {
          return "class = \"positive\"";
        }
      });

      Handlebars.registerHelper("formatSpeed", function(num) {
        if(isNaN(num))
          return "N/A";

        return num.toFixed(3).toString() + " Mb/s";
      });

      Handlebars.registerHelper("link", function(url) {
        var shortened = url;

        if(url.length > 80) {
          shortened = shortened.substring(0, 80) + "...";
        }

        return new Handlebars.SafeString("<a href=\"" + url + "\">" + shortened + "</a>");
      });

      // Helper to pretty-print JSON in a template
      Handlebars.registerHelper("stringify", function(arg) {
        return JSON.stringify(arg, null, 2);
      });
      
      function updateDownloaders() {
        $.get("../downloaders.json", function(resp) {
          let ready = 0;
          let unresponsive = 0;

          for(let worker of resp) {
            let seconds = worker.stats.downloadTime / 1000;
            let megabits = worker.stats.downloadBytes / 1024 / 128;

            worker.stats.speed = megabits / seconds;

            if(worker.state == "ready" || worker.state == "busy") {
              ready += 1;
            } else {
              unresponsive += 1;
            }
          }

          $("#downloadersList").html(downloadersTemplate(resp));
          $("#numDownloaders").html(resp.length);
          $("#readyDownloaders").html(ready);
          $("#unresponsiveDownloaders").html(unresponsive);
        });
      }

      updateDownloaders();
      setInterval(updateDownloaders, 5000);
    });
  </script>

  <link rel="stylesheet" type="text/css" class="ui" href="dist/semantic.min.css">
</head>

<body>
  <div class="ui menu">
    <div class="ui container">
      <a href="#" class="header item">
        BigSemantics Logs
      </a>
      <a href="./" class="item">Tasks</a>
      <a href="agents.html" class="item">Agents</a>
      <a href="downloaders.html" class="item active">Downloaders</a>
      <div class="right menu">
        <div class="item">
          <div class="ui icon input">
            <input type="text" placeholder="Search...">
            <i class="search link icon"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="ui main text container">
    <div class="ui three statistics">
      <div class="statistic">
        <div id="numDownloaders" class="value">
          0
        </div>
        <div class="label">
          Agents
        </div>
      </div>

      <div class="green statistic">
        <div id="readyDownloaders" class="value">
          0
        </div>
        <div class="label">
          Ready
        </div>
      </div>

      <div class="red statistic">
        <div id="unresponsiveDownloaders" class="value">
          0
        </div>
        <div class="label">
          Unresponsive
        </div>
      </div>
    </div>
  </div>

  <div class="ui container tasks">
    <table id="downloadersList" class="ui celled selectable table">
    </table>
  </div>
</body>

</html>